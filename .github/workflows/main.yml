# This is a GitHub Actions workflow file.
# It automatically builds a .exe from your Python script and uploads it
# as an asset to any new "Release" you create on GitHub.

name: Build and Release EXE

# Trigger this workflow on push to the main branch
# ONLY IF main.py or requirements.txt have changed.
on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'requirements.txt'

jobs:
  build:
    # Use a Windows runner because we are building a .exe
    runs-on: windows-latest

    # --- ADD THIS BLOCK TO GRANT WRITE PERMISSIONS ---
    permissions:
      contents: write
    # --- END OF FIX ---

    steps:
      # 1. Check out your repository's code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up a Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # You can change this version if needed

      # 3. Install your script's dependencies and PyInstaller
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 4. Run PyInstaller to build the .exe
      - name: Build executable
        run: >
          pyinstaller 
          --onefile 
          --windowed 
          --name WebScraper 
          --hidden-import=requests 
          --hidden-import=bs4 
          --hidden-import=tkinter 
          main.py

      # --- MODIFIED STEP: Use a more robust regex to fix SyntaxError ---
      # This regex captures the opening quote (Group 1) and the version (Group 2),
      # then matches the opening quote again ( \1 )
      - name: Extract Version from main.py
        id: extract_version
        run: |
          version=$(python -c "import re; content=open('main.py', 'r').read(); print(re.search(r'CURRENT_VERSION\s*=\s*([\"\'])(.*?)\1', content).group(2))")
          echo "Found version: $version"
          echo "VERSION_TAG=$version" >> $GITHUB_OUTPUT
        shell: bash
      # --- END OF MODIFICATION ---

      # 5. Create or update a release using the extracted version
      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          # Use the output from the 'extract_version' step as the tag
          tag_name: ${{ steps.extract_version.outputs.VERSION_TAG }}

          # Also use the version in the release name
          name: Version ${{ steps.extract_version.outputs.VERSION_TAG }} (from main)

          prerelease: false
          make_latest: true
          allow_updates: true
          # Files to upload.
          files: ./dist/WebScraper.exe
        env:
          # The GitHub token is required to create/update releases.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}