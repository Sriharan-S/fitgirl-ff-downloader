# This is a GitHub Actions workflow file.
# It automatically builds a .exe from your Python script and uploads it
# as an asset to any new "Release" you create on GitHub.

name: Build and Release EXE

# --- MODIFIED TRIGGER ---
# Trigger this workflow on push to the main branch
# ONLY IF main.py or requirements.txt have changed.
on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'requirements.txt'
# --- END OF MODIFICATION ---

jobs:
  build:
    # Use a Windows runner because we are building a .exe
    runs-on: windows-latest

    # --- ADD THIS BLOCK TO GRANT WRITE PERMISSIONS ---
    permissions:
      contents: write
    # --- END OF FIX ---

    steps:
      # 1. Check out your repository's code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up a Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # You can change this version if needed

      # 3. Install your script's dependencies and PyInstaller
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 4. Run PyInstaller to build the .exe
      #    --onefile: Bundles everything into a single executable
      #    --windowed: Prevents the black console window from opening
      #    --name: Sets the final name of your .exe file
      #    --hidden-import: Ensures specific libraries are bundled
      - name: Build executable
        run: >
          pyinstaller 
          --onefile 
          --windowed 
          --name WebScraper 
          --hidden-import=requests 
          --hidden-import=bs4 
          --hidden-import=tkinter 
          main.py

      # --- NEW STEP: Extract the version from main.py ---
      # This step reads main.py, finds the version string, and saves it
      # to an output variable named 'VERSION_TAG'
      - name: Extract Version from main.py
        id: extract_version
        run: |
          $version = python -c "import re; content=open('main.py', 'r').read(); print(re.search(r'CURRENT_VERSION\s*=\s*[\"']([^\"']+)[\"']', content).group(1))"
          Write-Host "Found version: $version"
          echo "VERSION_TAG=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: powershell
      # --- END OF NEW STEP ---

      # 5. Create or update a release using the extracted version
      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          # Use the output from the 'extract_version' step as the tag
          tag_name: ${{ steps.extract_version.outputs.VERSION_TAG }}

          # Also use the version in the release name
          name: Version ${{ steps.extract_version.outputs.VERSION_TAG }} (from main)

          prerelease: false
          # 'make_latest' is no longer needed when using versioned tags,
          # but we can keep 'true' to mark this as the "Latest" release
          make_latest: true
          # 'true' allows this action to overwrite an existing release
          # IF the tag already exists (e.g., re-running a failed build)
          allow_updates: true
          # Files to upload.
          files: ./dist/WebScraper.exe
        env:
          # The GitHub token is required to create/update releases.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}